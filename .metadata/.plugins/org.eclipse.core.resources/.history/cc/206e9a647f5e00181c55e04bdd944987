package fast1718.trabajo;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

//import javax.naming.NamingException;
//import javax.naming.InitialContext;
//import javax.naming.NamingException;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

/**
 * Servlet Filter implementation class FiltroMenu
 */
//TODO MODIFICAR
@WebFilter(urlPatterns={"/menu"})
public class FiltroMenu implements Filter {

	/**
	 * Default constructor.
	 */
	public FiltroMenu() {
	}

	/**
	 * @see Filter#destroy()
	 */
	public void destroy() {
	}

	/**
	 * @see Filter#doFilter(ServletRequest, ServletResponse, FilterChain)
	 */
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
			throws IOException, ServletException {
		HttpServletRequest req = (HttpServletRequest) request;
		HttpServletResponse res = (HttpServletResponse) response;
		
		//Comprueba si es un login
		String usu = req.getParameter("usu");
		String contra = req.getParameter("contra");
		
		if (usu != null && contra != null)
		{
			Usuario usuario = new Usuario();
			//Valida contrase√±a y usuario
			boolean verificado = false;
			try {
				DataSource ds = (DataSource) req.getServletContext().getAttribute("ds");
				Connection conn = ds.getConnection();

				String sql = "SELECT tipo_usu FROM usuarios WHERE id_usuario=? AND password=?";
				PreparedStatement st = conn.prepareStatement(sql);
				st.setString(1, usu);
				st.setString(2, contra);
				ResultSet rs = st.executeQuery();
				
				if (rs.next()) {
					verificado = true;
					//TODO COMPLETAR
					usuario= new Usuario(usu,contra, rs.getBoolean(3));
				
				}
				rs.close();
				st.close();
				conn.close();
			} catch (SQLException e) {
				e.printStackTrace();
				System.out.println("Error de acceso a la base de datos. FiltroMenu");
			}
			
			//Si es correcto, crea objetos en session
			if (verificado)
			{
				//TODO COMPLETAR
				req.getSession().setAttribute("usuario", usuario);
				// Creamos la cookie
				Cookie usuCookie = new Cookie( "usuario", usu);
				res.addCookie(usuCookie);
			}
			
		}
		
		Usuario usuario = (Usuario) req.getSession().getAttribute("usuario");
		if (usuario != null) {
			//TODO COMPLETAR
			if(usuario.getEsAdmin()==true) {

		
		
		
		} else {
			request.getRequestDispatcher("/").forward(request, response);
		}

	}

	/**
	 * @see Filter#init(FilterConfig)
	 */
	public void init(FilterConfig fConfig) throws ServletException {
	}

}
